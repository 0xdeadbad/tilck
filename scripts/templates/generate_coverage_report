#!/bin/bash
# SPDX-License-Identifier: BSD-2-Clause

# If USE_GCOV is empty/unset but TRAVIS/CIRCLECI is set, exit
# In other words, the USE_GCOV controls this script only if it is running
# under TRAVIS or CIRCLECI, which makes sense.

if [[ "$TRAVIS" != "" || "$CIRCLECI" != "" ]]; then
   if [[ "$USE_GCOV" == "" ]]; then
      echo "Exit 0 without doing anything"
      exit 0
   fi
fi

TC="@TCROOT@"
GCOV="@GCOV_TOOL@"
BUILD="@CMAKE_BINARY_DIR@"
HTML_DIR="@COVERAGE_HTML_DIR@"

LCOV="$TC/lcov/bin/lcov"
GENHTML="$TC/lcov/bin/genhtml"

cd "$BUILD"

gcda_count=$(find . -name '*.gcda' | wc -l)
if [[ $gcda_count == 0 ]]; then
   echo "ERROR: no gcda files found in $BUILD"
   exit 1
fi

$LCOV -d . --capture --gcov-tool "$GCOV" -o lcov.info
$LCOV --remove lcov.info '@TCROOT@/*' '/usr/include/*' -o lcov2.info

if [[ "$1" == "--codecov" ]]; then

   $LCOV --list lcov2.info

   # Upload report to CodeCov
   bash <(curl -s https://codecov.io/bash) || echo "Codecov did not collect coverage reports"
fi

# (Eventually) remove and create the output coverage directory
rm -rf "$HTML_DIR"; mkdir -p "$HTML_DIR"

# Generate the HTML coverage output
$GENHTML --output-directory "$HTML_DIR" lcov2.info

# Remove all the coverage data files generated by the current run
find . -type f -name '*.gcda' -print | xargs /bin/rm -f
rm lcov*.info
