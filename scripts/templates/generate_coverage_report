#!/bin/bash
# SPDX-License-Identifier: BSD-2-Clause

# If TEST_GCOV is empty/unset but TRAVIS/CIRCLECI is set, exit
# In other words, the TEST_GCOV controls this script only if it is running
# under TRAVIS or CIRCLECI, which makes sense.

if [[ "$TRAVIS" != "" || "$CIRCLECI" != "" ]]; then
   if [[ "$TEST_GCOV" == "" ]]; then
      echo "Exit 0 without doing anything"
      exit 0
   fi
fi

set -e # exit if any command fails

source @CMAKE_SOURCE_DIR@/scripts/bash_includes/script_utils

TC="@TCROOT@"
BUILD="@CMAKE_BINARY_DIR@"

HTML_DIR="@COVERAGE_HTML_DIR@"
GCOV="@TOOL_GCOV@"

# Sets $GCOV
echo "NOTE: Use '$GCOV' as gcov tool"

LCOV="$TC/lcov/bin/lcov"
GENHTML="$TC/lcov/bin/genhtml"

cd "$BUILD"

gcda_count=$(find . -name '*.gcda' | wc -l)
if [[ $gcda_count == 0 ]]; then
   echo "ERROR: no gcda files found in $BUILD"
   exit 1
fi

if [[ "$1" != "--acc" ]]; then
   rm -f lcov*.info
fi

$LCOV -d . --capture --gcov-tool "$GCOV" -o lcov.info

# Hack used to identify negative counters (convert them to a magic number)
sed -E -i 's/,-(.+)/,123456789/g' lcov.info

$LCOV --remove lcov.info '@TCROOT@/*' '/usr/include/*' -o lcov2.info

if [[ "$1" != "--acc" || ! -f coverage.info ]]; then
   mv lcov2.info coverage.info
else
   lcov -a coverage.info -a lcov2.info -o merged.info
   mv merged.info coverage.info
fi

if [[ "$1" == "--codecov" ]]; then

   $LCOV --list coverage.info

   # Upload report to CodeCov
   bash <(curl -s https://codecov.io/bash) || echo "Codecov did not collect coverage reports"

else

   # (Eventually) remove and create the output coverage directory
   rm -rf "$HTML_DIR"; mkdir -p "$HTML_DIR"

   # Generate the HTML coverage output
   $GENHTML --output-directory "$HTML_DIR" coverage.info
fi

# Remove all the coverage data files generated by the current run
find . -type f -name '*.gcda' -print | xargs /bin/rm -f

